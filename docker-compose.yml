services:
  ollama-mcp-bridge:
    image: python:3.11-slim
    container_name: ollama-mcp-bridge
    working_dir: /app
    command: >
      sh -c "pip install ollama-mcp-bridge &&
      ollama-mcp-bridge --config /app/mcp-config.json --host 0.0.0.0 --port 8000 --ollama-url ${OLLAMA_URL:-https://ollama.crisper.skills.eliaschen.dev}"
    ports:
      - "8000:8000"
    volumes:
      - ./backend/mcp-config.docker.json:/app/mcp-config.json:ro
    environment:
      - OLLAMA_URL=${OLLAMA_URL:-https://ollama.crisper.skills.eliaschen.dev}
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: crisper-backend
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - JWT_SECRET=${JWT_SECRET:-ruru}
      - OLLAMA_BRIDGE=http://ollama-mcp-bridge:8000
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen2.5:0.5b}
      - SQLITE_PATH=sqlite.db
    depends_on:
      - ollama-mcp-bridge
    restart: unless-stopped
